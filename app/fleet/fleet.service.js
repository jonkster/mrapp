"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var nativescript_couchbase_1 = require("nativescript-couchbase");
var aircraft_service_1 = require("../aircraft-details/aircraft.service");
var FleetService = /** @class */ (function () {
    function FleetService(aircraftService) {
        this.aircraftService = aircraftService;
        this.reverse = false;
        this.database = new nativescript_couchbase_1.Couchbase("aircraft-database");
        var push = this.database.createPushReplication("http://mcap.australiaeast.cloudapp.azure.com:4984/mcdata");
        var pull = this.database.createPullReplication("http://mcap.australiaeast.cloudapp.azure.com:4984/mcdata");
        pull.setContinuous(true);
        push.setContinuous(true);
        pull.start();
        push.start();
        this.database.createView("aircraft", "1", function (document, emitter) {
            if (document.rego) {
                emitter.emit(document._id, document);
            }
        });
        this.query();
    }
    FleetService.prototype.makeNewAircraft = function (aircraft) {
        var documentId = this.database.createDocument({
            "rego": aircraft.rego,
            "ttis": aircraft.ttis,
            "type": aircraft.type,
            "hrsAtMaint": aircraft.hrsAtMaint,
            "engineHrsAtMaint": aircraft.engineHrsAtMaint,
            "propHrsAtMaint": aircraft.propHrsAtMaint,
            "clockTime": aircraft.clockTime,
            "clockOffset": aircraft.clockOffset,
            "maintenance": aircraft.maintenance
        });
    };
    FleetService.prototype.getFleet = function () {
        this.query();
        return this.aircraft;
    };
    FleetService.prototype.getAircraft = function (id) {
        return this.aircraft.filter(function (aircraft) { return aircraft._id === id; })[0];
    };
    FleetService.prototype.deleteAircraft = function (id) {
        this.database.deleteDocument(id);
        this.aircraft = this.database.executeQuery("aircraft");
    };
    FleetService.prototype.getDaysLeft = function (ac) {
        return this.aircraftService.getDaysLeft(ac);
    };
    FleetService.prototype.query = function () {
        this.aircraft = this.database.executeQuery("aircraft");
        this.hourList = this.sortByHours(this.aircraft);
    };
    FleetService.prototype.regoExists = function (rego) {
        var r = this.aircraft.filter(function (aircraft) { return aircraft.rego === rego; })[0];
        return (r !== undefined);
    };
    FleetService.prototype.compareByDate = function (a, b) {
        var aLeft = a.daysLeft;
        var bLeft = b.daysLeft;
        if (aLeft === undefined) {
            aLeft = 10000;
        }
        if (bLeft === undefined) {
            bLeft = 10000;
        }
        if (aLeft < bLeft) {
            return -1;
        }
        if (aLeft > bLeft) {
            return 1;
        }
        if (a.type === 'hours') {
            return this.compareByHours(a, b);
        }
        return 0;
    };
    FleetService.prototype.compareByEstimatedDate = function (a, b) {
        var aLeft = a.daysLeft;
        var bLeft = b.daysLeft;
        if (aLeft === undefined) {
            aLeft = 10000;
        }
        if (bLeft === undefined) {
            bLeft = 10000;
        }
        if (a.type === 'hours') {
            aLeft = a.hoursLeft / 2;
        }
        if (b.type === 'hours') {
            bLeft = b.hoursLeft / 2;
        }
        if (aLeft < bLeft) {
            return -1;
        }
        if (aLeft > bLeft) {
            return 1;
        }
        return 0;
    };
    FleetService.prototype.compareByHours = function (a, b) {
        var aLeft = a.hoursLeft;
        var bLeft = b.hoursLeft;
        if (aLeft === undefined) {
            aLeft = 10000;
        }
        if (bLeft === undefined) {
            bLeft = 10000;
        }
        if (aLeft < bLeft) {
            return -1;
        }
        if (aLeft > bLeft) {
            return 1;
        }
        if (a.type === 'date') {
            return this.compareByDate(a, b);
        }
        return 0;
    };
    FleetService.prototype.compareByType = function (a, b) {
        var aLeft = a.type;
        var bLeft = b.type;
        if (aLeft < bLeft) {
            return -1;
        }
        if (aLeft > bLeft) {
            return 1;
        }
        if (a.rego < b.rego) {
            return -1;
        }
        if (a.rego > b.rego) {
            return 1;
        }
        return 0;
    };
    FleetService.prototype.getDate = function () {
        return this.dateList;
    };
    FleetService.prototype.getEstimatedDate = function () {
        return this.estimatedDateList;
    };
    FleetService.prototype.getHours = function () {
        return this.hourList;
    };
    FleetService.prototype.getType = function () {
        return this.typeList;
    };
    FleetService.prototype.reverseSort = function () {
        this.reverse = !this.reverse;
    };
    FleetService.prototype.sortByHours = function (aircraft) {
        var _this = this;
        this.hourList = [];
        this.dateList = [];
        for (var i = 0; i < aircraft.length; i++) {
            var ac = aircraft[i];
            this.hourList.push({
                '_id': ac._id,
                'rego': ac.rego,
                'item': '100 hourly',
                'hoursLeft': this.aircraftService.getHrsLeft(ac),
                'daysLeft': this.aircraftService.getDaysLeft(ac)
            });
            for (var j = 0; j < ac.maintenance.length; j++) {
                var item = ac.maintenance[j];
                if (item.maintenance !== "") {
                    var hleft = undefined;
                    var dleft = undefined;
                    if (item.type == 'hours') {
                        hleft = item.dueHrs - ac.ttis;
                    }
                    else {
                        dleft = this.aircraftService.getMaintDaysLeft(item.dueDateTuple);
                    }
                    this.hourList.push({
                        '_id': ac._id,
                        'rego': ac.rego,
                        'type': item.type,
                        'item': item.maintenance,
                        'hoursLeft': hleft,
                        'daysLeft': dleft
                    });
                }
            }
            for (var j = 0; j < ac.propHrsAtMaint.length; j++) {
                var hleft = Math.round((ac.engineHrsAtMaint[j] - ac.ttis) * 10) / 10;
                this.hourList.push({
                    '_id': ac._id,
                    'rego': ac.rego,
                    'type': 'hours',
                    'item': 'engine o/h',
                    'hoursLeft': hleft,
                    'daysLeft': undefined
                });
                hleft = Math.round((ac.propHrsAtMaint[j] - ac.ttis) * 10) / 10;
                this.hourList.push({
                    '_id': ac._id,
                    'rego': ac.rego,
                    'type': 'hours',
                    'item': 'prop o/h',
                    'hoursLeft': hleft,
                    'daysLeft': undefined
                });
            }
        }
        this.hourList = this.hourList.sort(function (a, b) { return _this.compareByHours(a, b); });
        this.dateList = Object.assign([], this.hourList);
        this.dateList = this.dateList.sort(function (a, b) { return _this.compareByDate(a, b); });
        this.estimatedDateList = Object.assign([], this.hourList);
        this.estimatedDateList = this.estimatedDateList.sort(function (a, b) { return _this.compareByEstimatedDate(a, b); });
        this.typeList = Object.assign([], this.hourList);
        this.typeList = this.typeList.sort(function (a, b) { return _this.compareByType(a, b); });
        if (this.reverse) {
            this.hourList = this.hourList.reverse();
        }
        return this.hourList;
    };
    FleetService.prototype.updateAircraft = function (ac) {
        this.database.updateDocument(ac._id, ac);
        this.aircraft = this.database.executeQuery("aircraft");
    };
    FleetService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [aircraft_service_1.AircraftService])
    ], FleetService);
    return FleetService;
}());
exports.FleetService = FleetService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxlZXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZsZWV0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFDM0MsaUVBQWlEO0FBQ2pELHlFQUF1RTtBQUt2RTtJQVNFLHNCQUFvQixlQUFnQztRQUFoQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFOMUMsWUFBTyxHQUFZLEtBQUssQ0FBQztRQU83QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksa0NBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ25ELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUMsMERBQTBELENBQUMsQ0FBQztRQUUzRyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLDBEQUEwRCxDQUFDLENBQUM7UUFFM0csSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXpCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUViLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsVUFBUyxRQUFRLEVBQUUsT0FBTztZQUNoRSxFQUFFLENBQUEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDZixPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDekMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFTSxzQ0FBZSxHQUF0QixVQUF1QixRQUFrQjtRQUNqQyxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGNB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QztJQUVNLHFDQUFjLEdBQXJCLFVBQXNCLEVBQVk7UUFDMUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUF6UVEsWUFBWTtRQUR4QixpQkFBVSxFQUFFO3lDQVUwQixrQ0FBZTtPQVR6QyxZQUFZLENBMlF4QjtJQUFELG1CQUFDO0NBQUEsQUEzUUQsSUEyUUM7QUEzUVksb0NBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0NvdWNoYmFzZX0gZnJvbSAnbmF0aXZlc2NyaXB0LWNvdWNoYmFzZSc7XG5pbXBvcnQgeyBBaXJjcmFmdFNlcnZpY2UgfSBmcm9tIFwiLi4vYWlyY3JhZnQtZGV0YWlscy9haXJjcmFmdC5zZXJ2aWNlXCI7XG5cbmltcG9ydCB7IEFpcmNyYWZ0LCBNYWludGVuYW5jZUl0ZW0gfSBmcm9tIFwiLi9haXJjcmFmdFwiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRmxlZXRTZXJ2aWNlIHtcbiAgICBwdWJsaWMgZGF0YWJhc2U6IGFueTtcbiAgICBwcml2YXRlIGFpcmNyYWZ0OiBBaXJjcmFmdFtdO1xuICAgIHByaXZhdGUgcmV2ZXJzZTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgZGF0ZUxpc3Q6IGFueVtdO1xuICAgIHByaXZhdGUgaG91ckxpc3Q6IGFueVtdO1xuICAgIHByaXZhdGUgdHlwZUxpc3Q6IGFueVtdO1xuICAgIHByaXZhdGUgZXN0aW1hdGVkRGF0ZUxpc3Q6IGFueVtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYWlyY3JhZnRTZXJ2aWNlOiBBaXJjcmFmdFNlcnZpY2UpIHsgXG4gICAgICAgIHRoaXMuZGF0YWJhc2UgPSBuZXcgQ291Y2hiYXNlKFwiYWlyY3JhZnQtZGF0YWJhc2VcIik7XG4gICAgICAgIGxldCBwdXNoID0gdGhpcy5kYXRhYmFzZS5jcmVhdGVQdXNoUmVwbGljYXRpb24oXCJodHRwOi8vbWNhcC5hdXN0cmFsaWFlYXN0LmNsb3VkYXBwLmF6dXJlLmNvbTo0OTg0L21jZGF0YVwiKTtcblxuICAgICAgICBsZXQgcHVsbCA9IHRoaXMuZGF0YWJhc2UuY3JlYXRlUHVsbFJlcGxpY2F0aW9uKFwiaHR0cDovL21jYXAuYXVzdHJhbGlhZWFzdC5jbG91ZGFwcC5henVyZS5jb206NDk4NC9tY2RhdGFcIik7XG5cbiAgICAgICAgcHVsbC5zZXRDb250aW51b3VzKHRydWUpO1xuICAgICAgICBwdXNoLnNldENvbnRpbnVvdXModHJ1ZSk7XG5cbiAgICAgICAgcHVsbC5zdGFydCgpO1xuICAgICAgICBwdXNoLnN0YXJ0KCk7XG5cbiAgICAgICAgdGhpcy5kYXRhYmFzZS5jcmVhdGVWaWV3KFwiYWlyY3JhZnRcIiwgXCIxXCIsIGZ1bmN0aW9uKGRvY3VtZW50LCBlbWl0dGVyKSB7XG4gICAgICAgICAgICBpZihkb2N1bWVudC5yZWdvKSB7XG4gICAgICAgICAgICAgICAgZW1pdHRlci5lbWl0KGRvY3VtZW50Ll9pZCwgZG9jdW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnF1ZXJ5KCk7XG4gICAgfVxuXG4gICAgcHVibGljIG1ha2VOZXdBaXJjcmFmdChhaXJjcmFmdDogQWlyY3JhZnQpIHtcbiAgICAgICAgICAgIGxldCBkb2N1bWVudElkID0gdGhpcy5kYXRhYmFzZS5jcmVhdGVEb2N1bWVudCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJyZWdvXCI6IGFpcmNyYWZ0LnJlZ28sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ0dGlzXCI6IGFpcmNyYWZ0LnR0aXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJ0eXBlXCI6IGFpcmNyYWZ0LnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJocnNBdE1haW50XCI6IGFpcmNyYWZ0Lmhyc0F0TWFpbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJlbmdpbmVIcnNBdE1haW50XCI6IGFpcmNyYWZ0LmVuZ2luZUhyc0F0TWFpbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJwcm9wSHJzQXRNYWludFwiOiBhaXJjcmFmdC5wcm9wSHJzQXRNYWludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImNsb2NrVGltZVwiOiBhaXJjcmFmdC5jbG9ja1RpbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJjbG9ja09mZnNldFwiOiBhaXJjcmFmdC5jbG9ja09mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIm1haW50ZW5hbmNlXCI6IGFpcmNyYWZ0Lm1haW50ZW5hbmNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0RmxlZXQoKTogQWlyY3JhZnRbXSB7XG4gICAgICAgIHRoaXMucXVlcnkoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWlyY3JhZnQ7XG4gICAgfVxuXG4gICAgZ2V0QWlyY3JhZnQoaWQ6IHN0cmluZyk6IEFpcmNyYWZ0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWlyY3JhZnQuZmlsdGVyKCBhaXJjcmFmdCA9PiBhaXJjcmFmdC5faWQgPT09IGlkKVswXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVsZXRlQWlyY3JhZnQoaWQ6IHN0cmluZykge1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5kZWxldGVEb2N1bWVudChpZCk7XG4gICAgICAgICAgICB0aGlzLmFpcmNyYWZ0ID0gIHRoaXMuZGF0YWJhc2UuZXhlY3V0ZVF1ZXJ5KFwiYWlyY3JhZnRcIik7XG4gICAgfVxuXG4gICAgcHVibGljIGdldERheXNMZWZ0KGFjOiBBaXJjcmFmdCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXREYXlzTGVmdChhYyk7XG4gICAgfVxuXG4gICAgcHVibGljIHF1ZXJ5KCkge1xuICAgICAgICAgICAgdGhpcy5haXJjcmFmdCA9ICB0aGlzLmRhdGFiYXNlLmV4ZWN1dGVRdWVyeShcImFpcmNyYWZ0XCIpO1xuICAgICAgICAgICAgdGhpcy5ob3VyTGlzdCA9IHRoaXMuc29ydEJ5SG91cnModGhpcy5haXJjcmFmdCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZ29FeGlzdHMocmVnbzogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCByID0gdGhpcy5haXJjcmFmdC5maWx0ZXIoYWlyY3JhZnQgPT4gYWlyY3JhZnQucmVnbyA9PT0gcmVnbylbMF07XG4gICAgICAgIHJldHVybiAociAhPT0gdW5kZWZpbmVkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbXBhcmVCeURhdGUoYTogYW55LCBiOiBhbnkpIHtcbiAgICAgICAgICAgIGxldCBhTGVmdDpudW1iZXIgPSBhLmRheXNMZWZ0O1xuICAgICAgICAgICAgbGV0IGJMZWZ0Om51bWJlciA9IGIuZGF5c0xlZnRcblxuICAgICAgICAgICAgaWYgKGFMZWZ0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBhTGVmdCA9IDEwMDAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGJMZWZ0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBiTGVmdCA9IDEwMDAwO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYUxlZnQgPCBiTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYUxlZnQgPiBiTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhLnR5cGUgPT09ICdob3VycycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb21wYXJlQnlIb3VycyhhLCBiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29tcGFyZUJ5RXN0aW1hdGVkRGF0ZShhOiBhbnksIGI6IGFueSkge1xuICAgICAgICAgICAgbGV0IGFMZWZ0Om51bWJlciA9IGEuZGF5c0xlZnQ7XG4gICAgICAgICAgICBsZXQgYkxlZnQ6bnVtYmVyID0gYi5kYXlzTGVmdFxuXG4gICAgICAgICAgICBpZiAoYUxlZnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGFMZWZ0ID0gMTAwMDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYkxlZnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGJMZWZ0ID0gMTAwMDA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhLnR5cGUgPT09ICdob3VycycpIHtcbiAgICAgICAgICAgICAgICAgICAgYUxlZnQgPSBhLmhvdXJzTGVmdCAvIDI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYi50eXBlID09PSAnaG91cnMnKSB7XG4gICAgICAgICAgICAgICAgICAgIGJMZWZ0ID0gYi5ob3Vyc0xlZnQgLyAyO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYUxlZnQgPCBiTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYUxlZnQgPiBiTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29tcGFyZUJ5SG91cnMoYTogYW55LCBiOiBhbnkpIHtcbiAgICAgICAgICAgIGxldCBhTGVmdDpudW1iZXIgPSBhLmhvdXJzTGVmdDtcbiAgICAgICAgICAgIGxldCBiTGVmdDpudW1iZXIgPSBiLmhvdXJzTGVmdFxuXG4gICAgICAgICAgICBpZiAoYUxlZnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGFMZWZ0ID0gMTAwMDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYkxlZnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGJMZWZ0ID0gMTAwMDA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhTGVmdCA8IGJMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhTGVmdCA+IGJMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGEudHlwZSA9PT0gJ2RhdGUnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tcGFyZUJ5RGF0ZShhLCBiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29tcGFyZUJ5VHlwZShhOiBhbnksIGI6IGFueSkge1xuICAgICAgICAgICAgbGV0IGFMZWZ0OnN0cmluZyA9IGEudHlwZTtcbiAgICAgICAgICAgIGxldCBiTGVmdDpzdHJpbmcgPSBiLnR5cGVcblxuICAgICAgICAgICAgaWYgKGFMZWZ0IDwgYkxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFMZWZ0ID4gYkxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYS5yZWdvIDwgYi5yZWdvKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhLnJlZ28gPiBiLnJlZ28pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZUxpc3Q7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEVzdGltYXRlZERhdGUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmVzdGltYXRlZERhdGVMaXN0O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRIb3VycygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaG91ckxpc3Q7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFR5cGUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnR5cGVMaXN0O1xuICAgIH1cblxuICAgIHB1YmxpYyByZXZlcnNlU29ydCgpIHtcbiAgICAgICAgdGhpcy5yZXZlcnNlID0gISB0aGlzLnJldmVyc2U7XG4gICAgfVxuXG4gICAgcHVibGljIHNvcnRCeUhvdXJzKGFpcmNyYWZ0OiBBaXJjcmFmdFtdKSB7XG4gICAgICAgIHRoaXMuaG91ckxpc3QgPSBbXTsgXG4gICAgICAgIHRoaXMuZGF0ZUxpc3QgPSBbXTsgXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWlyY3JhZnQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgYWMgPSBhaXJjcmFmdFtpXTtcbiAgICAgICAgICAgICAgICB0aGlzLmhvdXJMaXN0LnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfaWQnOiBhYy5faWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZWdvJzogYWMucmVnbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2l0ZW0nOiAnMTAwIGhvdXJseScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdob3Vyc0xlZnQnOiB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXRIcnNMZWZ0KGFjKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RheXNMZWZ0JzogdGhpcy5haXJjcmFmdFNlcnZpY2UuZ2V0RGF5c0xlZnQoYWMpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFjLm1haW50ZW5hbmNlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbTogTWFpbnRlbmFuY2VJdGVtID0gYWMubWFpbnRlbmFuY2Vbal07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5tYWludGVuYW5jZSAhPT0gXCJcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGxlZnQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkbGVmdCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0udHlwZSA9PSAnaG91cnMnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxlZnQgPSBpdGVtLmR1ZUhycyAtIGFjLnR0aXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGxlZnQgPSB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXRNYWludERheXNMZWZ0KGl0ZW0uZHVlRGF0ZVR1cGxlKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaG91ckxpc3QucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19pZCc6IGFjLl9pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVnbyc6IGFjLnJlZ28sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiBpdGVtLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2l0ZW0nOiBpdGVtLm1haW50ZW5hbmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdob3Vyc0xlZnQnOiBobGVmdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGF5c0xlZnQnOiBkbGVmdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBhYy5wcm9wSHJzQXRNYWludC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhsZWZ0ID0gTWF0aC5yb3VuZCgoYWMuZW5naW5lSHJzQXRNYWludFtqXSAtIGFjLnR0aXMpICogMTApIC8gMTA7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhvdXJMaXN0LnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfaWQnOiBhYy5faWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlZ28nOiBhYy5yZWdvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ2hvdXJzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXRlbSc6ICdlbmdpbmUgby9oJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaG91cnNMZWZ0JzogaGxlZnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RheXNMZWZ0JzogdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaGxlZnQgPSBNYXRoLnJvdW5kKChhYy5wcm9wSHJzQXRNYWludFtqXSAtIGFjLnR0aXMpICogMTApIC8gMTA7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhvdXJMaXN0LnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfaWQnOiBhYy5faWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlZ28nOiBhYy5yZWdvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJzogJ2hvdXJzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXRlbSc6ICdwcm9wIG8vaCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hvdXJzTGVmdCc6IGhsZWZ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXlzTGVmdCc6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ob3VyTGlzdCA9IHRoaXMuaG91ckxpc3Quc29ydCgoYSwgYikgPT4gdGhpcy5jb21wYXJlQnlIb3VycyhhLCBiKSk7XG5cbiAgICAgICAgdGhpcy5kYXRlTGlzdCA9IE9iamVjdC5hc3NpZ24oW10sIHRoaXMuaG91ckxpc3QpO1xuICAgICAgICB0aGlzLmRhdGVMaXN0ID0gdGhpcy5kYXRlTGlzdC5zb3J0KChhLCBiKSA9PiB0aGlzLmNvbXBhcmVCeURhdGUoYSwgYikpO1xuXG4gICAgICAgIHRoaXMuZXN0aW1hdGVkRGF0ZUxpc3QgPSBPYmplY3QuYXNzaWduKFtdLCB0aGlzLmhvdXJMaXN0KTtcbiAgICAgICAgdGhpcy5lc3RpbWF0ZWREYXRlTGlzdCA9IHRoaXMuZXN0aW1hdGVkRGF0ZUxpc3Quc29ydCgoYSwgYikgPT4gdGhpcy5jb21wYXJlQnlFc3RpbWF0ZWREYXRlKGEsIGIpKTtcblxuICAgICAgICB0aGlzLnR5cGVMaXN0ID0gT2JqZWN0LmFzc2lnbihbXSwgdGhpcy5ob3VyTGlzdCk7XG4gICAgICAgIHRoaXMudHlwZUxpc3QgPSB0aGlzLnR5cGVMaXN0LnNvcnQoKGEsIGIpID0+IHRoaXMuY29tcGFyZUJ5VHlwZShhLCBiKSk7XG5cbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuaG91ckxpc3QgPSB0aGlzLmhvdXJMaXN0LnJldmVyc2UoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5ob3VyTGlzdDtcbiAgICB9ICAgIFxuXG4gICAgcHVibGljIHVwZGF0ZUFpcmNyYWZ0KGFjOiBBaXJjcmFmdCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS51cGRhdGVEb2N1bWVudChhYy5faWQsIGFjKTtcbiAgICAgICAgICAgIHRoaXMuYWlyY3JhZnQgPSAgdGhpcy5kYXRhYmFzZS5leGVjdXRlUXVlcnkoXCJhaXJjcmFmdFwiKTtcbiAgICB9XG5cbn1cbiJdfQ==