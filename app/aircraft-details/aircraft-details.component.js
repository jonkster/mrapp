"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var router_2 = require("nativescript-angular/router");
var fleet_service_1 = require("../common/fleet.service");
var aircraft_service_1 = require("../common/aircraft.service");
var permissions_service_1 = require("../permissions.service");
var dialogs = require("ui/dialogs");
var AircraftDetailsComponent = /** @class */ (function () {
    function AircraftDetailsComponent(route, routerExtensions, aircraftService, permissionsService, fleetService) {
        this.route = route;
        this.routerExtensions = routerExtensions;
        this.aircraftService = aircraftService;
        this.permissionsService = permissionsService;
        this.fleetService = fleetService;
        this.hoursLeft = 0;
        this.daysLeft = 0;
        this.engineLeft = ['0', '0'];
        this.propLeft = ['0', '0'];
    }
    AircraftDetailsComponent.prototype.ngOnInit = function () {
        var id = this.route.snapshot.params["id"];
        this.aircraft = this.fleetService.getAircraft(id);
        this.updateValues();
    };
    AircraftDetailsComponent.prototype.can = function (action) {
        return this.permissionsService.can(action);
    };
    AircraftDetailsComponent.prototype.getEngine = function (num) {
        var v = this.aircraft.engineHrsAtMaint[num].toString();
        if (v === '987654321') {
            v = 'OC';
        }
        return v;
    };
    AircraftDetailsComponent.prototype.getProp = function (num) {
        var v = this.aircraft.propHrsAtMaint[num].toString();
        if (v === '987654321') {
            v = 'OC';
        }
        return v;
    };
    AircraftDetailsComponent.prototype.updateValues = function () {
        this.hoursLeft = this.aircraftService.getHrsLeft(this.aircraft);
        this.daysLeft = this.aircraftService.getDaysLeft(this.aircraft);
        for (var i = 0; i < this.aircraft.engineHrsAtMaint.length; i++) {
            this.engineLeft[i] = this.aircraftService.getEngineLeft(this.aircraft, i + 1).toString();
            this.propLeft[i] = this.aircraftService.getPropLeft(this.aircraft, i + 1).toString();
            if (this.aircraft.engineHrsAtMaint[i] === 987654321) {
                this.engineLeft[i] = 'OC';
            }
            if (this.aircraft.propHrsAtMaint[i] === 987654321) {
                this.propLeft[i] = 'OC';
            }
        }
    };
    AircraftDetailsComponent.prototype.adjustClockTime = function (args) {
        var textField = args.object;
        this.aircraft.clockTime = parseInt(textField.text);
    };
    AircraftDetailsComponent.prototype.adjustOffsetTime = function (args) {
        var textField = args.object;
        this.aircraft.clockOffset = parseInt(textField.text);
    };
    AircraftDetailsComponent.prototype.doubleConfirmDelete = function (ac) {
        var _this = this;
        dialogs.confirm({
            title: "Delete Aircraft",
            message: "If you enter Delete, " + ac.rego + " WILL BE DELETED!",
            okButtonText: "Keep " + ac.rego,
            cancelButtonText: "Delete",
        }).then(function (result) {
            if (!result) {
                _this.fleetService.deleteAircraft(ac._id);
                _this.routerExtensions.navigate(["/fleet"], { clearHistory: true });
            }
        });
    };
    AircraftDetailsComponent.prototype.deleteAircraft = function (ac) {
        var _this = this;
        dialogs.confirm({
            title: "Delete Aircraft",
            message: "Are you sure you want to delete " + ac.rego + "?",
            okButtonText: "Delete",
            cancelButtonText: "Keep " + ac.rego,
        }).then(function (result) {
            if (result) {
                _this.doubleConfirmDelete(ac);
            }
        });
    };
    AircraftDetailsComponent.prototype.clearMaintenanceItem = function (num) {
        var item = this.aircraft.maintenance[num];
        item.cleared = !item.cleared;
    };
    AircraftDetailsComponent.prototype.deleteMaintenanceItem = function (num) {
        var _this = this;
        var item = this.aircraft.maintenance[num];
        dialogs.confirm({
            title: "Delete Maintenance Item",
            message: "Are you sure you want to delete #" + (num + 1) + " " + item.maintenance + "?",
            okButtonText: "Delete",
            cancelButtonText: "Keep" + item.maintenance,
        }).then(function (result) {
            if (result) {
                _this.aircraft.maintenance.splice(num, 1);
            }
        });
    };
    AircraftDetailsComponent.prototype.getDateStringFromTuple = function (dt) {
        var st = "";
        if (dt !== undefined) {
            if (dt[0] !== undefined) {
                st = String(dt[0]);
            }
            if (dt[1] !== undefined) {
                st += '/' + String(dt[1]);
            }
            if (dt[2] !== undefined) {
                st += '/' + String(dt[2]);
            }
        }
        return st;
    };
    AircraftDetailsComponent.prototype.getDaysLeft = function (date) {
        var exDate = new Date(date[0], date[1] - 1, date[2]);
        var time = exDate.valueOf() - Date.now().valueOf();
        return Math.round(time / (24 * 60 * 60 * 1000));
    };
    AircraftDetailsComponent.prototype.getHoursLeft = function (hrs) {
        return Math.round((hrs - this.aircraft.ttis) * 10) / 10;
    };
    AircraftDetailsComponent.prototype.save = function (ac) {
        this.fleetService.updateAircraft(ac);
        this.routerExtensions.navigate(["/fleet"], { clearHistory: true });
    };
    AircraftDetailsComponent.prototype.onLoadDate = function (ev) {
        var datePicker = ev.object;
        if (this.aircraft.annualDateTuple[0] !== undefined) {
            datePicker.year = this.aircraft.annualDateTuple[0];
            datePicker.month = this.aircraft.annualDateTuple[1];
            datePicker.day = this.aircraft.annualDateTuple[2];
        }
    };
    AircraftDetailsComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'app-aircraft-details',
            templateUrl: './aircraft-details.component.html',
            styleUrls: ['./aircraft-details.component.scss']
        }),
        __metadata("design:paramtypes", [router_1.ActivatedRoute,
            router_2.RouterExtensions,
            aircraft_service_1.AircraftService,
            permissions_service_1.PermissionsService,
            fleet_service_1.FleetService])
    ], AircraftDetailsComponent);
    return AircraftDetailsComponent;
}());
exports.AircraftDetailsComponent = AircraftDetailsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlyY3JhZnQtZGV0YWlscy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhaXJjcmFmdC1kZXRhaWxzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFrRDtBQUNsRCwwQ0FBaUQ7QUFDakQsc0RBQStEO0FBSy9ELHlEQUF1RDtBQUN2RCwrREFBNkQ7QUFDN0QsOERBQTREO0FBRTVELG9DQUFzQztBQVF0QztJQU9RLGtDQUFvQixLQUFxQixFQUNqQixnQkFBa0MsRUFDbEMsZUFBZ0MsRUFDaEMsa0JBQXNDLEVBQ3RDLFlBQTBCO1FBSjlCLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ2pCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFUMUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixhQUFRLEdBQVcsQ0FBQyxDQUFDO1FBQ3JCLGVBQVUsR0FBYSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsQyxhQUFRLEdBQWEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFPeEMsQ0FBQztJQUVELDJDQUFRLEdBQVI7UUFDUSxJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELHNDQUFHLEdBQUgsVUFBSSxNQUFjO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkQs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LFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUM3QyxVQUFVLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25ELFVBQVUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsVUFBVSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxRCxDQUFDO0lBQ1QsQ0FBQztJQXJKSSx3QkFBd0I7UUFOcEMsZ0JBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQixRQUFRLEVBQUUsc0JBQXNCO1lBQ2hDLFdBQVcsRUFBRSxtQ0FBbUM7WUFDaEQsU0FBUyxFQUFFLENBQUMsbUNBQW1DLENBQUM7U0FDakQsQ0FBQzt5Q0FRaUMsdUJBQWM7WUFDQyx5QkFBZ0I7WUFDakIsa0NBQWU7WUFDWix3Q0FBa0I7WUFDeEIsNEJBQVk7T0FYN0Msd0JBQXdCLENBc0pwQztJQUFELCtCQUFDO0NBQUEsQUF0SkQsSUFzSkM7QUF0SlksNERBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuaW1wb3J0IHsgUm91dGVyRXh0ZW5zaW9ucyB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7IERhdGVQaWNrZXIgfSBmcm9tIFwidWkvZGF0ZS1waWNrZXJcIjtcbmltcG9ydCB7IFRleHRGaWVsZCB9IGZyb20gXCJ1aS90ZXh0LWZpZWxkXCI7XG5pbXBvcnQgeyBFdmVudERhdGEgfSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlXCI7XG5pbXBvcnQgeyBBaXJjcmFmdCwgTWFpbnRlbmFuY2VJdGVtIH0gZnJvbSBcIi4uL2NvbW1vbi9haXJjcmFmdFwiO1xuaW1wb3J0IHsgRmxlZXRTZXJ2aWNlIH0gZnJvbSBcIi4uL2NvbW1vbi9mbGVldC5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBBaXJjcmFmdFNlcnZpY2UgfSBmcm9tIFwiLi4vY29tbW9uL2FpcmNyYWZ0LnNlcnZpY2VcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zU2VydmljZSB9IGZyb20gXCIuLi9wZXJtaXNzaW9ucy5zZXJ2aWNlXCI7XG5cbmltcG9ydCAqIGFzIGRpYWxvZ3MgZnJvbSBcInVpL2RpYWxvZ3NcIjtcblxuQENvbXBvbmVudCh7XG4gIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gIHNlbGVjdG9yOiAnYXBwLWFpcmNyYWZ0LWRldGFpbHMnLFxuICB0ZW1wbGF0ZVVybDogJy4vYWlyY3JhZnQtZGV0YWlscy5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2FpcmNyYWZ0LWRldGFpbHMuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBBaXJjcmFmdERldGFpbHNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgICAgICBwcml2YXRlIGFpcmNyYWZ0OiBBaXJjcmFmdDtcbiAgICAgICAgcHJpdmF0ZSBob3Vyc0xlZnQ6IG51bWJlciA9IDA7XG4gICAgICAgIHByaXZhdGUgZGF5c0xlZnQ6IG51bWJlciA9IDA7XG4gICAgICAgIHByaXZhdGUgZW5naW5lTGVmdDogc3RyaW5nW10gPSBbJzAnLCAnMCddO1xuICAgICAgICBwcml2YXRlIHByb3BMZWZ0OiBzdHJpbmdbXSA9IFsnMCcsICcwJ107XG5cbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlckV4dGVuc2lvbnM6IFJvdXRlckV4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIGFpcmNyYWZ0U2VydmljZTogQWlyY3JhZnRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBwZXJtaXNzaW9uc1NlcnZpY2U6IFBlcm1pc3Npb25zU2VydmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGUgZmxlZXRTZXJ2aWNlOiBGbGVldFNlcnZpY2UpIHtcbiAgICAgICAgfVxuXG4gICAgICAgIG5nT25Jbml0KCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJhbXNbXCJpZFwiXTtcbiAgICAgICAgICAgICAgICB0aGlzLmFpcmNyYWZ0ID0gdGhpcy5mbGVldFNlcnZpY2UuZ2V0QWlyY3JhZnQoaWQpO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVmFsdWVzKCk7XG4gICAgICAgIH1cblxuICAgICAgICBjYW4oYWN0aW9uOiBzdHJpbmcpIDogYm9vbGVhbiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmNhbihhY3Rpb24pO1xuICAgICAgICB9XG5cblx0Z2V0RW5naW5lKG51bTogbnVtYmVyKSA6IHN0cmluZyB7XG5cdFx0bGV0IHY6c3RyaW5nID0gdGhpcy5haXJjcmFmdC5lbmdpbmVIcnNBdE1haW50W251bV0udG9TdHJpbmcoKTtcblx0XHRpZiAodiA9PT0gJzk4NzY1NDMyMScpIHtcblx0XHRcdHYgPSAnT0MnO1xuXHRcdH1cblx0XHRyZXR1cm4gdjtcblx0fVxuXG5cdGdldFByb3AobnVtOiBudW1iZXIpIDogc3RyaW5nIHtcblx0XHRsZXQgdjpzdHJpbmcgPSB0aGlzLmFpcmNyYWZ0LnByb3BIcnNBdE1haW50W251bV0udG9TdHJpbmcoKTtcblx0XHRpZiAodiA9PT0gJzk4NzY1NDMyMScpIHtcblx0XHRcdHYgPSAnT0MnO1xuXHRcdH1cblx0XHRyZXR1cm4gdjtcblx0fVxuXG4gICAgICAgIHVwZGF0ZVZhbHVlcygpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmhvdXJzTGVmdCA9IHRoaXMuYWlyY3JhZnRTZXJ2aWNlLmdldEhyc0xlZnQodGhpcy5haXJjcmFmdCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXlzTGVmdCA9IHRoaXMuYWlyY3JhZnRTZXJ2aWNlLmdldERheXNMZWZ0KHRoaXMuYWlyY3JhZnQpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5haXJjcmFmdC5lbmdpbmVIcnNBdE1haW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZ2luZUxlZnRbaV0gPSB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXRFbmdpbmVMZWZ0KHRoaXMuYWlyY3JhZnQsIGkrMSkudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvcExlZnRbaV0gPSB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXRQcm9wTGVmdCh0aGlzLmFpcmNyYWZ0LCBpKzEpLnRvU3RyaW5nKCk7XG5cdFx0XHRpZiAodGhpcy5haXJjcmFmdC5lbmdpbmVIcnNBdE1haW50W2ldID09PSA5ODc2NTQzMjEpIHtcblx0XHRcdFx0dGhpcy5lbmdpbmVMZWZ0W2ldID0gJ09DJztcblx0XHRcdH1cblx0XHRcdGlmICh0aGlzLmFpcmNyYWZ0LnByb3BIcnNBdE1haW50W2ldID09PSA5ODc2NTQzMjEpIHtcblx0XHRcdFx0dGhpcy5wcm9wTGVmdFtpXSA9ICdPQyc7XG5cdFx0XHR9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYWRqdXN0Q2xvY2tUaW1lKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBsZXQgdGV4dEZpZWxkID0gPFRleHRGaWVsZD5hcmdzLm9iamVjdDtcbiAgICAgICAgICAgICAgICB0aGlzLmFpcmNyYWZ0LmNsb2NrVGltZSA9IHBhcnNlSW50KHRleHRGaWVsZC50ZXh0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFkanVzdE9mZnNldFRpbWUoYXJncykge1xuICAgICAgICAgICAgICAgIGxldCB0ZXh0RmllbGQgPSA8VGV4dEZpZWxkPmFyZ3Mub2JqZWN0O1xuICAgICAgICAgICAgICAgIHRoaXMuYWlyY3JhZnQuY2xvY2tPZmZzZXQgPSBwYXJzZUludCh0ZXh0RmllbGQudGV4dCk7XG4gICAgICAgIH1cblxuICAgICAgICBkb3VibGVDb25maXJtRGVsZXRlKGFjOiBBaXJjcmFmdCkge1xuICAgICAgICAgICAgICAgIGRpYWxvZ3MuY29uZmlybSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJEZWxldGUgQWlyY3JhZnRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiSWYgeW91IGVudGVyIERlbGV0ZSwgXCIgKyBhYy5yZWdvICsgXCIgV0lMTCBCRSBERUxFVEVEIVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIktlZXAgXCIgKyBhYy5yZWdvLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uVGV4dDogXCJEZWxldGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZsZWV0U2VydmljZS5kZWxldGVBaXJjcmFmdChhYy5faWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVyRXh0ZW5zaW9ucy5uYXZpZ2F0ZShbXCIvZmxlZXRcIl0sIHsgY2xlYXJIaXN0b3J5OiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbn1cblxuICAgICAgICBkZWxldGVBaXJjcmFmdChhYzogQWlyY3JhZnQpIHtcbiAgICAgICAgICAgICAgICBkaWFsb2dzLmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiRGVsZXRlIEFpcmNyYWZ0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgXCIgKyBhYy5yZWdvICsgXCI/XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiRGVsZXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIktlZXAgXCIgKyBhYy5yZWdvLFxuICAgICAgICAgICAgICAgIH0pLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3VibGVDb25maXJtRGVsZXRlKGFjKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjbGVhck1haW50ZW5hbmNlSXRlbShudW06IG51bWJlcikge1xuICAgICAgICAgICAgICAgIGxldCBpdGVtID0gdGhpcy5haXJjcmFmdC5tYWludGVuYW5jZVtudW1dO1xuICAgICAgICAgICAgICAgIGl0ZW0uY2xlYXJlZCA9ICEgaXRlbS5jbGVhcmVkXG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGVNYWludGVuYW5jZUl0ZW0obnVtOiBudW1iZXIpIHtcbiAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IHRoaXMuYWlyY3JhZnQubWFpbnRlbmFuY2VbbnVtXTtcbiAgICAgICAgICAgICAgICBkaWFsb2dzLmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiRGVsZXRlIE1haW50ZW5hbmNlIEl0ZW1cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRlbGV0ZSAjXCIgKyAobnVtKzEpICsgXCIgXCIgKyBpdGVtLm1haW50ZW5hbmNlICsgXCI/XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiRGVsZXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIktlZXBcIiArIGl0ZW0ubWFpbnRlbmFuY2UsXG4gICAgICAgICAgICAgICAgfSkudGhlbigocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcmNyYWZ0Lm1haW50ZW5hbmNlLnNwbGljZShudW0sIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBnZXREYXRlU3RyaW5nRnJvbVR1cGxlKGR0OiBudW1iZXJbXSk6IHN0cmluZyB7XG4gICAgICAgICAgICAgICAgbGV0IHN0ID0gXCJcIjtcbiAgICAgICAgICAgICAgICBpZiAoZHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR0WzBdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3QgPSBTdHJpbmcoZHRbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR0WzFdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3QgKz0gJy8nICsgU3RyaW5nKGR0WzFdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkdFsyXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ICs9ICcvJyArIFN0cmluZyhkdFsyXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBzdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBnZXREYXlzTGVmdChkYXRlOiBudW1iZXJbXSk6IG51bWJlciB7XG4gICAgICAgICAgICAgICAgbGV0IGV4RGF0ZSA9IG5ldyBEYXRlKGRhdGVbMF0sIGRhdGVbMV0tMSwgZGF0ZVsyXSk7XG4gICAgICAgICAgICAgICAgbGV0IHRpbWUgPSBleERhdGUudmFsdWVPZigpIC0gRGF0ZS5ub3coKS52YWx1ZU9mKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodGltZSAvICgyNCo2MCo2MCoxMDAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBwdWJsaWMgZ2V0SG91cnNMZWZ0KGhyczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCgoaHJzIC0gdGhpcy5haXJjcmFmdC50dGlzKSoxMCkvMTA7XG4gICAgICAgIH1cblxuICAgICAgICBzYXZlKGFjOiBBaXJjcmFmdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmxlZXRTZXJ2aWNlLnVwZGF0ZUFpcmNyYWZ0KGFjKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJvdXRlckV4dGVuc2lvbnMubmF2aWdhdGUoW1wiL2ZsZWV0XCJdLCB7IGNsZWFySGlzdG9yeTogdHJ1ZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9uTG9hZERhdGUoZXYpIHtcbiAgICAgICAgICAgICAgICBsZXQgZGF0ZVBpY2tlciA9IDxEYXRlUGlja2VyPmV2Lm9iamVjdDtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVBpY2tlci55ZWFyID0gdGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyLm1vbnRoID0gdGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyLmRheSA9IHRoaXMuYWlyY3JhZnQuYW5udWFsRGF0ZVR1cGxlWzJdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgfVxufVxuIl19