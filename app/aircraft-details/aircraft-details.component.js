"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var router_2 = require("nativescript-angular/router");
var fleet_service_1 = require("../common/fleet.service");
var aircraft_service_1 = require("../common/aircraft.service");
var permissions_service_1 = require("../permissions.service");
var dialogs = require("ui/dialogs");
var AircraftDetailsComponent = /** @class */ (function () {
    function AircraftDetailsComponent(route, routerExtensions, aircraftService, permissionsService, fleetService) {
        this.route = route;
        this.routerExtensions = routerExtensions;
        this.aircraftService = aircraftService;
        this.permissionsService = permissionsService;
        this.fleetService = fleetService;
        this.hoursLeft = 0;
        this.daysLeft = 0;
        this.engineLeft = [0, 0];
        this.propLeft = [0, 0];
    }
    AircraftDetailsComponent.prototype.ngOnInit = function () {
        var id = this.route.snapshot.params["id"];
        this.aircraft = this.fleetService.getAircraft(id);
        this.updateValues();
    };
    AircraftDetailsComponent.prototype.can = function (action) {
        return this.permissionsService.can(action);
    };
    AircraftDetailsComponent.prototype.updateValues = function () {
        this.hoursLeft = this.aircraftService.getHrsLeft(this.aircraft);
        this.daysLeft = this.aircraftService.getDaysLeft(this.aircraft);
        for (var i = 0; i < this.aircraft.engineHrsAtMaint.length; i++) {
            this.engineLeft[i] = this.aircraftService.getEngineLeft(this.aircraft, i + 1);
            this.propLeft[i] = this.aircraftService.getPropLeft(this.aircraft, i + 1);
        }
    };
    AircraftDetailsComponent.prototype.adjustClockTime = function (args) {
        var textField = args.object;
        this.aircraft.clockTime = parseInt(textField.text);
    };
    AircraftDetailsComponent.prototype.adjustOffsetTime = function (args) {
        var textField = args.object;
        this.aircraft.clockOffset = parseInt(textField.text);
    };
    AircraftDetailsComponent.prototype.doubleConfirmDelete = function (ac) {
        var _this = this;
        dialogs.confirm({
            title: "Delete Aircraft",
            message: "If you enter Delete, " + ac.rego + " WILL BE DELETED!",
            okButtonText: "Keep " + ac.rego,
            cancelButtonText: "Delete",
        }).then(function (result) {
            if (!result) {
                _this.fleetService.deleteAircraft(ac._id);
                _this.routerExtensions.navigate(["/fleet"], { clearHistory: true });
            }
        });
    };
    AircraftDetailsComponent.prototype.deleteAircraft = function (ac) {
        var _this = this;
        dialogs.confirm({
            title: "Delete Aircraft",
            message: "Are you sure you want to delete " + ac.rego + "?",
            okButtonText: "Delete",
            cancelButtonText: "Keep " + ac.rego,
        }).then(function (result) {
            if (result) {
                _this.doubleConfirmDelete(ac);
            }
        });
    };
    AircraftDetailsComponent.prototype.clearMaintenanceItem = function (num) {
        var item = this.aircraft.maintenance[num];
        item.cleared = !item.cleared;
    };
    AircraftDetailsComponent.prototype.deleteMaintenanceItem = function (num) {
        var _this = this;
        var item = this.aircraft.maintenance[num];
        dialogs.confirm({
            title: "Delete Maintenance Item",
            message: "Are you sure you want to delete #" + (num + 1) + " " + item.maintenance + "?",
            okButtonText: "Delete",
            cancelButtonText: "Keep" + item.maintenance,
        }).then(function (result) {
            if (result) {
                _this.aircraft.maintenance.splice(num, 1);
            }
        });
    };
    AircraftDetailsComponent.prototype.getDateStringFromTuple = function (dt) {
        var st = "";
        if (dt !== undefined) {
            if (dt[0] !== undefined) {
                st = String(dt[0]);
            }
            if (dt[1] !== undefined) {
                st += '/' + String(dt[1]);
            }
            if (dt[2] !== undefined) {
                st += '/' + String(dt[2]);
            }
        }
        return st;
    };
    AircraftDetailsComponent.prototype.getDaysLeft = function (date) {
        var exDate = new Date(date[0], date[1] - 1, date[2]);
        var time = exDate.valueOf() - Date.now().valueOf();
        return Math.round(time / (24 * 60 * 60 * 1000));
    };
    AircraftDetailsComponent.prototype.getHoursLeft = function (hrs) {
        return Math.round((hrs - this.aircraft.ttis) * 10) / 10;
    };
    AircraftDetailsComponent.prototype.save = function (ac) {
        this.fleetService.updateAircraft(ac);
        this.routerExtensions.navigate(["/fleet"], { clearHistory: true });
    };
    AircraftDetailsComponent.prototype.onLoadDate = function (ev) {
        var datePicker = ev.object;
        if (this.aircraft.annualDateTuple[0] !== undefined) {
            datePicker.year = this.aircraft.annualDateTuple[0];
            datePicker.month = this.aircraft.annualDateTuple[1];
            datePicker.day = this.aircraft.annualDateTuple[2];
        }
    };
    AircraftDetailsComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'app-aircraft-details',
            templateUrl: './aircraft-details.component.html',
            styleUrls: ['./aircraft-details.component.scss']
        }),
        __metadata("design:paramtypes", [router_1.ActivatedRoute,
            router_2.RouterExtensions,
            aircraft_service_1.AircraftService,
            permissions_service_1.PermissionsService,
            fleet_service_1.FleetService])
    ], AircraftDetailsComponent);
    return AircraftDetailsComponent;
}());
exports.AircraftDetailsComponent = AircraftDetailsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlyY3JhZnQtZGV0YWlscy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhaXJjcmFmdC1kZXRhaWxzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFrRDtBQUNsRCwwQ0FBaUQ7QUFDakQsc0RBQStEO0FBSy9ELHlEQUF1RDtBQUN2RCwrREFBNkQ7QUFDN0QsOERBQTREO0FBRTVELG9DQUFzQztBQVF0QztJQU9RLGtDQUFvQixLQUFxQixFQUNqQixnQkFBa0MsRUFDbEMsZUFBZ0MsRUFDaEMsa0JBQXNDLEVBQ3RDLFlBQTBCO1FBSjlCLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ2pCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFUMUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixhQUFRLEdBQVcsQ0FBQyxDQUFDO1FBQ3JCLGVBQVUsR0FBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM5QixhQUFRLEdBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFPcEMsQ0FBQztJQUVELDJDQUFRLEdBQVI7UUFDUSxJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELHNDQUFHLEdBQUgsVUFBSSxNQUFjO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkQs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Q0FBQztJQUMzRSxDQUFDO0lBRUQsNkNBQVUsR0FBVixVQUFXLEVBQUU7UUFDTCxJQUFJLFVBQVUsR0FBZSxFQUFFLENBQUMsTUFBTSxDQUFDO1FBQ3ZDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuRCxVQUFVLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BELFVBQVUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQztJQUNULENBQUM7SUEvSEksd0JBQXdCO1FBTnBDLGdCQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDbkIsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyxXQUFXLEVBQUUsbUNBQW1DO1lBQ2hELFNBQVMsRUFBRSxDQUFDLG1DQUFtQyxDQUFDO1NBQ2pELENBQUM7eUNBUWlDLHVCQUFjO1lBQ0MseUJBQWdCO1lBQ2pCLGtDQUFlO1lBQ1osd0NBQWtCO1lBQ3hCLDRCQUFZO09BWDdDLHdCQUF3QixDQWdJcEM7SUFBRCwrQkFBQztDQUFBLEFBaElELElBZ0lDO0FBaElZLDREQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7IFJvdXRlckV4dGVuc2lvbnMgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXIvcm91dGVyXCI7XG5pbXBvcnQgeyBEYXRlUGlja2VyIH0gZnJvbSBcInVpL2RhdGUtcGlja2VyXCI7XG5pbXBvcnQgeyBUZXh0RmllbGQgfSBmcm9tIFwidWkvdGV4dC1maWVsZFwiO1xuaW1wb3J0IHsgRXZlbnREYXRhIH0gZnJvbSBcImRhdGEvb2JzZXJ2YWJsZVwiO1xuaW1wb3J0IHsgQWlyY3JhZnQsIE1haW50ZW5hbmNlSXRlbSB9IGZyb20gXCIuLi9jb21tb24vYWlyY3JhZnRcIjtcbmltcG9ydCB7IEZsZWV0U2VydmljZSB9IGZyb20gXCIuLi9jb21tb24vZmxlZXQuc2VydmljZVwiO1xuaW1wb3J0IHsgQWlyY3JhZnRTZXJ2aWNlIH0gZnJvbSBcIi4uL2NvbW1vbi9haXJjcmFmdC5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9uc1NlcnZpY2UgfSBmcm9tIFwiLi4vcGVybWlzc2lvbnMuc2VydmljZVwiO1xuXG5pbXBvcnQgKiBhcyBkaWFsb2dzIGZyb20gXCJ1aS9kaWFsb2dzXCI7XG5cbkBDb21wb25lbnQoe1xuICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICBzZWxlY3RvcjogJ2FwcC1haXJjcmFmdC1kZXRhaWxzJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2FpcmNyYWZ0LWRldGFpbHMuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9haXJjcmFmdC1kZXRhaWxzLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQWlyY3JhZnREZXRhaWxzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICAgICAgcHJpdmF0ZSBhaXJjcmFmdDogQWlyY3JhZnQ7XG4gICAgICAgIHByaXZhdGUgaG91cnNMZWZ0OiBudW1iZXIgPSAwO1xuICAgICAgICBwcml2YXRlIGRheXNMZWZ0OiBudW1iZXIgPSAwO1xuICAgICAgICBwcml2YXRlIGVuZ2luZUxlZnQ6IG51bWJlcltdID0gWzAsIDBdO1xuICAgICAgICBwcml2YXRlIHByb3BMZWZ0OiBudW1iZXJbXSA9IFswLCAwXTtcblxuICAgICAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGVyRXh0ZW5zaW9uczogUm91dGVyRXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGUgYWlyY3JhZnRTZXJ2aWNlOiBBaXJjcmFmdFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogUGVybWlzc2lvbnNTZXJ2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBmbGVldFNlcnZpY2U6IEZsZWV0U2VydmljZSkge1xuICAgICAgICB9XG5cbiAgICAgICAgbmdPbkluaXQoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmFtc1tcImlkXCJdO1xuICAgICAgICAgICAgICAgIHRoaXMuYWlyY3JhZnQgPSB0aGlzLmZsZWV0U2VydmljZS5nZXRBaXJjcmFmdChpZCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVWYWx1ZXMoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNhbihhY3Rpb246IHN0cmluZykgOiBib29sZWFuIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuY2FuKGFjdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICB1cGRhdGVWYWx1ZXMoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ob3Vyc0xlZnQgPSB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXRIcnNMZWZ0KHRoaXMuYWlyY3JhZnQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF5c0xlZnQgPSB0aGlzLmFpcmNyYWZ0U2VydmljZS5nZXREYXlzTGVmdCh0aGlzLmFpcmNyYWZ0KTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYWlyY3JhZnQuZW5naW5lSHJzQXRNYWludC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmdpbmVMZWZ0W2ldID0gdGhpcy5haXJjcmFmdFNlcnZpY2UuZ2V0RW5naW5lTGVmdCh0aGlzLmFpcmNyYWZ0LCBpKzEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wTGVmdFtpXSA9IHRoaXMuYWlyY3JhZnRTZXJ2aWNlLmdldFByb3BMZWZ0KHRoaXMuYWlyY3JhZnQsIGkrMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYWRqdXN0Q2xvY2tUaW1lKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBsZXQgdGV4dEZpZWxkID0gPFRleHRGaWVsZD5hcmdzLm9iamVjdDtcbiAgICAgICAgICAgICAgICB0aGlzLmFpcmNyYWZ0LmNsb2NrVGltZSA9IHBhcnNlSW50KHRleHRGaWVsZC50ZXh0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFkanVzdE9mZnNldFRpbWUoYXJncykge1xuICAgICAgICAgICAgICAgIGxldCB0ZXh0RmllbGQgPSA8VGV4dEZpZWxkPmFyZ3Mub2JqZWN0O1xuICAgICAgICAgICAgICAgIHRoaXMuYWlyY3JhZnQuY2xvY2tPZmZzZXQgPSBwYXJzZUludCh0ZXh0RmllbGQudGV4dCk7XG4gICAgICAgIH1cblxuICAgICAgICBkb3VibGVDb25maXJtRGVsZXRlKGFjOiBBaXJjcmFmdCkge1xuICAgICAgICAgICAgICAgIGRpYWxvZ3MuY29uZmlybSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJEZWxldGUgQWlyY3JhZnRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiSWYgeW91IGVudGVyIERlbGV0ZSwgXCIgKyBhYy5yZWdvICsgXCIgV0lMTCBCRSBERUxFVEVEIVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIktlZXAgXCIgKyBhYy5yZWdvLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uVGV4dDogXCJEZWxldGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZsZWV0U2VydmljZS5kZWxldGVBaXJjcmFmdChhYy5faWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVyRXh0ZW5zaW9ucy5uYXZpZ2F0ZShbXCIvZmxlZXRcIl0sIHsgY2xlYXJIaXN0b3J5OiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbn1cblxuICAgICAgICBkZWxldGVBaXJjcmFmdChhYzogQWlyY3JhZnQpIHtcbiAgICAgICAgICAgICAgICBkaWFsb2dzLmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiRGVsZXRlIEFpcmNyYWZ0XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgXCIgKyBhYy5yZWdvICsgXCI/XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiRGVsZXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIktlZXAgXCIgKyBhYy5yZWdvLFxuICAgICAgICAgICAgICAgIH0pLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3VibGVDb25maXJtRGVsZXRlKGFjKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjbGVhck1haW50ZW5hbmNlSXRlbShudW06IG51bWJlcikge1xuICAgICAgICAgICAgICAgIGxldCBpdGVtID0gdGhpcy5haXJjcmFmdC5tYWludGVuYW5jZVtudW1dO1xuICAgICAgICAgICAgICAgIGl0ZW0uY2xlYXJlZCA9ICEgaXRlbS5jbGVhcmVkXG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGVNYWludGVuYW5jZUl0ZW0obnVtOiBudW1iZXIpIHtcbiAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IHRoaXMuYWlyY3JhZnQubWFpbnRlbmFuY2VbbnVtXTtcbiAgICAgICAgICAgICAgICBkaWFsb2dzLmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiRGVsZXRlIE1haW50ZW5hbmNlIEl0ZW1cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRlbGV0ZSAjXCIgKyAobnVtKzEpICsgXCIgXCIgKyBpdGVtLm1haW50ZW5hbmNlICsgXCI/XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiRGVsZXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIktlZXBcIiArIGl0ZW0ubWFpbnRlbmFuY2UsXG4gICAgICAgICAgICAgICAgfSkudGhlbigocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcmNyYWZ0Lm1haW50ZW5hbmNlLnNwbGljZShudW0sIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBnZXREYXRlU3RyaW5nRnJvbVR1cGxlKGR0OiBudW1iZXJbXSk6IHN0cmluZyB7XG4gICAgICAgICAgICAgICAgbGV0IHN0ID0gXCJcIjtcbiAgICAgICAgICAgICAgICBpZiAoZHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR0WzBdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3QgPSBTdHJpbmcoZHRbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR0WzFdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3QgKz0gJy8nICsgU3RyaW5nKGR0WzFdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkdFsyXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ICs9ICcvJyArIFN0cmluZyhkdFsyXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBzdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBnZXREYXlzTGVmdChkYXRlOiBudW1iZXJbXSk6IG51bWJlciB7XG4gICAgICAgICAgICAgICAgbGV0IGV4RGF0ZSA9IG5ldyBEYXRlKGRhdGVbMF0sIGRhdGVbMV0tMSwgZGF0ZVsyXSk7XG4gICAgICAgICAgICAgICAgbGV0IHRpbWUgPSBleERhdGUudmFsdWVPZigpIC0gRGF0ZS5ub3coKS52YWx1ZU9mKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodGltZSAvICgyNCo2MCo2MCoxMDAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBwdWJsaWMgZ2V0SG91cnNMZWZ0KGhyczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCgoaHJzIC0gdGhpcy5haXJjcmFmdC50dGlzKSoxMCkvMTA7XG4gICAgICAgIH1cblxuICAgICAgICBzYXZlKGFjOiBBaXJjcmFmdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmxlZXRTZXJ2aWNlLnVwZGF0ZUFpcmNyYWZ0KGFjKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJvdXRlckV4dGVuc2lvbnMubmF2aWdhdGUoW1wiL2ZsZWV0XCJdLCB7IGNsZWFySGlzdG9yeTogdHJ1ZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9uTG9hZERhdGUoZXYpIHtcbiAgICAgICAgICAgICAgICBsZXQgZGF0ZVBpY2tlciA9IDxEYXRlUGlja2VyPmV2Lm9iamVjdDtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZVBpY2tlci55ZWFyID0gdGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyLm1vbnRoID0gdGhpcy5haXJjcmFmdC5hbm51YWxEYXRlVHVwbGVbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyLmRheSA9IHRoaXMuYWlyY3JhZnQuYW5udWFsRGF0ZVR1cGxlWzJdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgfVxufVxuIl19